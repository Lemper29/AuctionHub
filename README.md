# Аукционная система - Auction Service

Проект представляет собой распределенную аукционную систему с использованием gRPC, gRPC-Gateway и PostgreSQL.

## Архитектура

Система состоит из двух основных компонентов:

1. **Auction Service** (gRPC сервер) - обрабатывает бизнес-логику аукциона
2. **API Gateway** (HTTP/REST сервер) - предоставляет REST API и преобразует запросы в gRPC

## Технологический стек

- **Go** - основной язык разработки
- **gRPC** - для межсервисного взаимодействия
- **gRPC-Gateway** - для предоставления REST API
- **PostgreSQL** - база данных
- **GORM** - ORM для работы с базой данных
- **Protocol Buffers** - для определения API контрактов

## Структура проекта

```
├── api-gateway/              # API Gateway сервис
│   ├── internal/
│   │   ├── config/          # Конфигурация
│   │   ├── handler/         # HTTP обработчики
│   │   └── utils/           # Утилиты
│   └── cmd/gateway/         # Точка входа API Gateway
├── auction-service/          # Основной аукционный сервис
│   ├── internal/
│   │   ├── config/          # Конфигурация
│   │   ├── server/          # gRPC сервер
│   │   ├── service/         # Бизнес-логика
│   │   ├── storage/         # Интерфейсы хранилища
│   │   └── storage/db/      # Реализация PostgreSQL хранилища
│   ├── pkg/models/          # Модели данных
│   └── cmd/server/          # Точка входа аукционного сервиса
├── gen/                     # Сгенерированный код из .proto файлов
│   └── auction/             # Сгенерированные gRPC структуры
├── protos/                  # Protocol Buffers определения
│   └── auction/             # .proto файлы аукциона
└── Makefile                 # Утилиты для сборки и запуска
```

## Функциональность

### Основные возможности:

1. **Создание лотов** - создание новых аукционных лотов с указанием параметров
2. **Получение информации о лоте** - просмотр текущего состояния лота
3. **Размещение ставок** - возможность делать ставки на активные лоты
4. **Подписка на обновления лота** - получение реальных обновлений по лоту через streaming

### Модели данных:

- **Lot** - аукционный лот с информацией о текущей цене, победителе, статусе
- **Bid** - ставка пользователя на конкретный лот

## Установка и запуск

### Предварительные требования

- Go 1.20+
- PostgreSQL
- protoc (Protocol Buffers compiler)
- grpc-gateway plugin

### Настройка окружения

Создайте файл `.env` в корне проекта:

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=0000
DB_NAME=auction_db

# Services
PORT_AUCTION_SERVICE=8080
PORT_API_GATEWAY_SERVICE=8081
PUBLIC_HOST=localhost
```

### Генерация кода

```bash
# Генерация всего кода (gRPC + Gateway + OpenAPI)
make gen

# Или отдельные цели:
make gen-grpc      # Только gRPC код
make gen-gateway   # gRPC-Gateway код
make gen-openapi   # OpenAPI документация
```

### Запуск сервисов

```bash
# Запуск аукционного сервиса (gRPC сервер)
make run-server

# Запуск API Gateway (HTTP сервер)
make run-gateway

# В отдельном терминале
```

### Миграции базы данных

```bash
# Применить миграции
make migrate-up

# Откатить миграции
make migrate-down
```

## API Endpoints

### REST API (через API Gateway)

- `POST /api/v1/lots` - Создать новый лот
- `GET /api/v1/lots/{lot_id}` - Получить информацию о лоте
- `POST /api/v1/lots/{lot_id}/bids` - Сделать ставку на лот
- `GET /api/v1/lots/{lot_id}/subscribe` - Подписаться на обновления лота (SSE)

### gRPC API

Система также предоставляет прямой gRPC API на порту 8080.

## Примеры использования

### Создание лота

```bash
curl -X POST http://localhost:8081/api/v1/lots \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Редкая книга",
    "description": "Антикварное издание 19 века",
    "startPrice": 1000.0,
    "durationMinute": 60
  }'
```

### Размещение ставки

```bash
curl -X POST http://localhost:8081/api/v1/lots/{lot_id}/bids \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "amount": 1500.0
  }'
```

### Подписка на обновления

```bash
curl http://localhost:8081/api/v1/lots/{lot_id}/subscribe
```

## Тестирование

Запуск тестов:

```bash
make test
```

## Сборка

```bash
# Сборка бинарных файлов
make build

# Docker сборка
make docker-build
```

## Клиентское приложение

В проекте также предоставлен интерактивный клиент (`client/main.go`), который позволяет взаимодействовать с системой через консоль:

```bash
cd client
go run main.go
```

## Мониторинг и отладка

Система включает подробное логирование для отладки:
- Логирование запросов к базе данных
- Логирование gRPC вызовов
- Логирование бизнес-логики

## Безопасность

- Валидация входных данных
- Проверка бизнес-правил (ставки должны быть выше текущей цены)
- Защита от несуществующих лотов

## Особенности реализации

- **Streaming обновления** - реальное время обновления через gRPC streaming
- **Транзакционность** - безопасное обновление данных при размещении ставок
- **Масштабируемость** - разделение на микросервисы позволяет масштабировать компоненты независимо
- **Кросс-платформенный API** - поддержка как gRPC, так и REST